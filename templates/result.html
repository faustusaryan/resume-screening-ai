<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Resume Match Result</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      transition: background-color 0.5s ease, color 0.5s ease;
    }
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    .card {
      border-radius: 16px;
    }
    .toggle-switch {
      position: absolute;
      top: 20px;
      right: 30px;
    }
    .fade-in {
      animation: fadeIn 1s ease forwards;
      opacity: 0;
      transform: translateY(20px);
    }
    @keyframes fadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .ring {
      width: 160px;
      height: 160px;
      position: relative;
    }
    .ring svg {
      transform: rotate(0deg);
    }
    .ring circle {
      fill: none;
      stroke-width: 14;
      stroke-linecap: round;
    }
    .ring text {
      font-size: 1.8rem;
      font-weight: bold;
      dominant-baseline: middle;
      text-anchor: middle;
      fill: #0d6efd;
    }
    body.dark-mode .ring text {
      fill: #90cdf4;
    }
    .scroll-box {
      max-height: 200px;
      overflow-y: auto;
      background-color: #ffffff;
      border-radius: 10px;
      padding: 15px;
      font-size: 0.95rem;
    }
    body.dark-mode .card,
    body.dark-mode .scroll-box,
    body.dark-mode table {
      background-color: #1e1e1e;
      color: #e0e0e0;
    }
    .score-text {
      font-size: 1.2rem;
      font-weight: 500;
    }
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
  </style>
</head>
<body class="bg-light">

  <!-- Dark Mode Toggle -->
  <div class="toggle-switch form-check form-switch">
    <input class="form-check-input" type="checkbox" id="modeSwitch" onclick="document.body.classList.toggle('dark-mode')">
    <label class="form-check-label" for="modeSwitch">üåô Dark</label>
  </div>

  <div class="container d-flex flex-column justify-content-center align-items-center py-5">
    <div class="card shadow p-4 fade-in w-100" style="max-width: 900px;">
      <h2 class="text-center mb-4">üìä Top Matching Resume</h2>

      <!-- Animated Progress Ring -->
      {% if best_match %}
      <div class="d-flex flex-column align-items-center mb-4">
        <div class="ring">
          <svg width="160" height="160">
            <circle r="70" cx="80" cy="80" stroke="#e9ecef" stroke-width="14"/>
            <circle id="progressRing" r="70" cx="80" cy="80" stroke="#0d6efd" stroke-width="14" stroke-dasharray="440" stroke-dashoffset="440" transform="rotate(-90 80 80)"/>
            <text x="80" y="80">{{ best_match.score }}%</text>
          </svg>
        </div>
        <p class="text-center fw-bold mt-3 score-text">Best Match: {{ best_match.filename }}</p>
      </div>
      {% endif %}

      <hr class="my-4">

      <!-- Bar Chart -->
      <h5 class="text-center mb-3">üìà Resume Score Chart</h5>
      <div class="chart-container">
        <canvas id="scoreChart"></canvas>
      </div>

      <!-- Score Table -->
      <h5 class="text-center mt-5 mb-3">üìÅ All Resume Scores</h5>
      <div class="table-responsive mb-4">
        <table class="table table-striped table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>Filename</th>
              <th>Match Score (%)</th>
            </tr>
          </thead>
          <tbody>
            {% for item in results %}
            <tr>
              <td>{{ item.filename }}</td>
              <td><strong>{{ item.score }}</strong></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Job Description Content -->
      <h5>üìù <strong>Job Description:</strong></h5>
      <div class="scroll-box border mb-3">{{ jd_text }}</div>

      <!-- Try Again Button -->
      <div class="text-center">
        <a href="/" class="btn btn-primary mt-2">üîÅ Try Again</a>
      </div>
    </div>
  </div>

  <!-- Hidden JSON Data for Chart -->
  <script id="chart-data" type="application/json">
  {
    "labels": {{ results | map(attribute='filename') | list | tojson | safe }},
    "scores": {{ results | map(attribute='score') | list | tojson | safe }}
  }
  </script>

  <!-- Animate Ring -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const score = Number("{{ best_match.score if best_match else 0 }}");
      const dash = 440;
      const offset = dash - (score / 100) * dash;
      const ring = document.getElementById('progressRing');
      
      if (ring) {
        ring.style.strokeDasharray = dash;
        ring.style.strokeDashoffset = dash;
        setTimeout(() => {
          ring.style.transition = 'stroke-dashoffset 1s ease-out';
          ring.style.strokeDashoffset = offset;
        }, 300);
      }
    });
  </script>

  <!-- Chart.js Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const ctx = document.getElementById('scoreChart');
        if (!ctx) {
          console.error('Chart canvas element not found');
          return;
        }

        const chartDataElement = document.getElementById('chart-data');
        const { labels, scores } = JSON.parse(chartDataElement.textContent);

        if (!labels || !scores || labels.length === 0) {
          console.error('No data available for chart');
          return;
        }

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Match Score (%)',
              data: scores,
              backgroundColor: '#0d6efd',
              borderRadius: 6,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 10
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.parsed.y.toFixed(2) + '%';
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error creating chart:', error);
      }
    });
  </script>

</body>
</html>
